---
# RHEL/Rocky/CentOS installation of gitlab-runner using official package script

- name: Ensure curl is present (used to add GitLab Runner repo)
  ansible.builtin.dnf:
    name: curl
    allowerasing: true
    state: present

- name: Add GitLab Runner yum repository (official script)
  ansible.builtin.command: "bash -c 'curl -fsSL {{ gitlab_runner_yum_repo }} | bash'"
  args:
    creates: /etc/yum.repos.d/runner_gitlab-runner.repo
  register: add_repo

- name: Install gitlab-runner package
  ansible.builtin.dnf:
    name: "gitlab-runner{{ ('-' + gitlab_runner_version) if gitlab_runner_version else '' }}"
    state: present

- name: Ensure gitlab-runner user exists
  ansible.builtin.user:
    name: gitlab-runner
    system: true
    create_home: false

- name: Ensure gitlab-runner service is enabled and started
  ansible.builtin.service:
    name: "{{ gitlab_runner_service_name }}"
    state: started
    enabled: true
  notify: Restart gitlab-runner

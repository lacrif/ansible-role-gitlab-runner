---
# Debian/Ubuntu installation of gitlab-runner using official package script

- name: Ensure curl is present (used to add GitLab Runner repo)
  ansible.builtin.apt:
    name: curl
    state: present

- name: Add GitLab Runner apt repository (official script)
  ansible.builtin.command: "bash -c 'curl -fsSL {{ gitlab_runner_apt_repo }} | bash'"
  args:
    creates: /etc/apt/sources.list.d/runner_gitlab-runner.list
  register: add_repo
  changed_when: add_repo.rc == 0 and add_repo.stdout != ''
  notify: Update apt cache

- name: Install gitlab-runner package
  ansible.builtin.apt:
    name: "gitlab-runner{{ ('=' + gitlab_runner_version) if gitlab_runner_version else '' }}"
    state: present
    allow_downgrade: yes

- name: Ensure gitlab-runner user exists
  ansible.builtin.user:
    name: gitlab-runner
    system: yes
    create_home: no

- name: Ensure gitlab-runner service is enabled and started
  ansible.builtin.service:
    name: "{{ gitlab_runner_service_name }}"
    state: started
    enabled: yes
  notify: Restart gitlab-runner

---
# Debian/Ubuntu installation of gitlab-runner using official package script

- name: Ensure curl is present (used to add GitLab Runner repo)
  ansible.builtin.apt:
    name: curl
    state: present

- name: Add GitLab Runner apt repository (official script)
  ansible.builtin.command: "bash -c 'curl -fsSL {{ gitlab_runner_apt_repo }} | bash'"
  args:
    creates: /etc/apt/sources.list.d/runner_gitlab-runner.list
  register: add_repo
  notify: Update apt cache

- name: Install gitlab-runner package
  ansible.builtin.apt:
    name: "gitlab-runner{{ ('=' + gitlab_runner_version) if gitlab_runner_version else '' }}"
    state: present
    allow_downgrade: true

- name: Ensure gitlab-runner user exists
  ansible.builtin.user:
    name: gitlab-runner
    system: true
    create_home: false

- name: Ensure gitlab-runner service is enabled and started
  ansible.builtin.service:
    name: "{{ gitlab_runner_service_name }}"
    state: started
    enabled: true
  notify: Restart gitlab-runner
